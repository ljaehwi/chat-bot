<!DOCTYPE html>
<html>
<head>
    <title>AI Agent WebSocket Test</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        #messageInput { width: 70%; padding: 5px; }
        #sendButton { padding: 5px 10px; }
        .log { color: #666; font-style: italic; }
        .error { color: red; }
        .token { color: #333; }
        .thinking { color: #999; font-style: italic; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.5; } }
    </style>
</head>
<body>
    <h1>AI Agent WebSocket Test</h1>
    
    <div>
        <label>User ID: <input type="number" id="userId" value="1" min="1"></label>
    </div>
    
    <div>
        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
        <button id="sendButton">ì „ì†¡</button>
        <button id="connectButton">ì—°ê²°</button>
        <button id="disconnectButton">ì—°ê²° í•´ì œ</button>
    </div>
    
    <div id="status">ì—°ê²° ìƒíƒœ: ì—°ê²° ì•ˆë¨</div>
    <div id="messages"></div>

    <script>
        let ws = null;
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const status = document.getElementById('status');
        const userId = document.getElementById('userId');

        function addMessage(content, className = '') {
            const div = document.createElement('div');
            div.className = className;
            div.textContent = content;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function connect() {
            if (ws) {
                ws.close();
            }

            ws = new WebSocket('ws://localhost:8000/ws/chat');
            
            ws.onopen = function() {
                status.textContent = 'ì—°ê²° ìƒíƒœ: ì—°ê²°ë¨';
                addMessage('âœ… WebSocket ì—°ê²° ì„±ê³µ', 'log');
                sendButton.disabled = false;
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'node_start') {
                    addMessage(data.content, 'log');
                } else if (data.type === 'node_end') {
                    addMessage(data.content, 'log');
                } else if (data.type === 'tool_start') {
                    addMessage(data.content, 'log');
                } else if (data.type === 'tool_end') {
                    addMessage(data.content, 'log');
                } else if (data.type === 'thinking') {
                    // ìƒê° ì¤‘ì¼ ë•ŒëŠ” ... í‘œì‹œ
                    const thinkingDiv = document.getElementById('thinking');
                    if (!thinkingDiv) {
                        const div = document.createElement('div');
                        div.id = 'thinking';
                        div.className = 'thinking';
                        div.textContent = 'ìƒê° ì¤‘...';
                        messages.appendChild(div);
                    }
                } else if (data.type === 'final_answer') {
                    // ìƒê° ì¤‘ í‘œì‹œ ì œê±°
                    const thinkingDiv = document.getElementById('thinking');
                    if (thinkingDiv) {
                        thinkingDiv.remove();
                    }
                    addMessage(data.content, 'token');
                } else if (data.type === 'error') {
                    addMessage('âŒ ' + data.content, 'error');
                } else if (data.type === 'end') {
                    addMessage('--- ì‘ë‹µ ì™„ë£Œ ---', 'log');
                }
            };

            ws.onclose = function() {
                status.textContent = 'ì—°ê²° ìƒíƒœ: ì—°ê²° ì•ˆë¨';
                addMessage('âŒ WebSocket ì—°ê²° ì¢…ë£Œ', 'log');
                sendButton.disabled = true;
            };

            ws.onerror = function(error) {
                addMessage('âŒ WebSocket ì˜¤ë¥˜: ' + error, 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('âŒ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const message = messageInput.value.trim();
            if (!message) return;

            const payload = {
                message: message,
                user_id: parseInt(userId.value)
            };

            addMessage('ğŸ“¤ ì „ì†¡: ' + message, 'log');
            ws.send(JSON.stringify(payload));
            messageInput.value = '';
        }

        // Event listeners
        connectButton.onclick = connect;
        disconnectButton.onclick = disconnect;
        sendButton.onclick = sendMessage;
        
        messageInput.onkeypress = function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        };

        // Auto connect on load
        connect();
    </script>
</body>
</html>